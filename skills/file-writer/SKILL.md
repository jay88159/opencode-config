---
name: file-writer
description: 文件持续编辑工具：支持创建、定位、改写三种核心操作。用于写作场景下对同一文件的持续迭代，而非每次新建。触发词：新建文件、写入文件、定位到第X行、找到某段、修改某处、替换内容、在某行插入、追加内容、编辑文件、改写、file write、locate line、edit file。
---

# File Writer

持续编辑单一文件的工作流，支持**创建、定位、改写**三种核心操作，适用于写作场景下的迭代式修改。

## 三种核心能力

| 能力 | 说明 | 典型场景 |
|------|------|----------|
| **创建/写入** | 新建文件或首次写入 | 开始新文档、初始化文件 |
| **定位** | 找到目标行/段/区域 | 准备编辑前的位置确认 |
| **改写** | 对定位区域增删改 | 替换、插入、删除、追加 |

---

## 一、创建/写入（Create/Write）

首次写入或创建新文件。

### 操作步骤

1. **确认路径**：询问或确认目标文件路径
2. **写入内容**：使用 Write 工具创建文件
3. **确认成功**：读取验证文件已创建

### 最佳实践

- 路径不存在时自动创建
- 写入前确认是否覆盖已有文件
- 大文件分段写入，避免一次性写入过多内容

---

## 二、定位（Locate）

在编辑前精确定位目标区域。**必须先读取文件**，再根据需求选择定位方式。

### 定位方式

#### 1. 按行号定位

```
用户："改第 10 行"
→ 读取文件，定位第 10 行内容

用户："修改第 5-15 行"
→ 读取文件，定位第 5 至 15 行的区间
```

**操作**：使用 Read 工具，可指定 `offset` 和 `limit` 读取特定行范围。

#### 2. 按关键词/正则搜索

```
用户："找到所有包含 TODO 的行"
→ 使用 Grep 工具搜索关键词

用户："定位到 function handleSubmit"
→ 搜索函数定义位置
```

**操作**：使用 Grep 工具搜索，返回匹配行及行号。

#### 3. 按唯一上下文匹配

```
用户："改 '## 第三章 设计方案' 这一节"
→ 搜索唯一标题，定位该节起止位置

用户："把 '用户需要登录后才能访问' 改成..."
→ 匹配唯一字符串作为定位锚点
```

**操作**：使用 Grep 确认唯一性，再用 StrReplace 的 `old_string` 精确匹配。

#### 4. 按段落/章节结构

```
用户："修改背景介绍部分"
→ 定位 ## 背景 到下一个 ## 之间的内容

用户："在第二节末尾追加"
→ 定位第二节的结束位置
```

**操作**：先读取文件理解结构，找到章节边界。

### 定位输出

定位完成后，向用户报告：

- 目标区域的行号范围（如 `第 23-45 行`）
- 区域的简要内容预览（首尾几行）
- 确认是否为用户期望的位置

---

## 三、改写（Edit）

对定位后的区域进行修改。**必须使用精确编辑，避免重写全文**。

### 编辑操作类型

#### 1. 替换（Replace）

将定位区域的内容替换为新内容。

```
操作：StrReplace
参数：
  - old_string: 定位到的原文（需唯一）
  - new_string: 替换后的新内容
```

**注意**：`old_string` 必须足够长以保证唯一匹配，通常包含 3-5 行上下文。

#### 2. 插入（Insert）

在指定位置插入新内容。

```
在某行之前插入：
  old_string: "目标行内容"
  new_string: "新内容\n目标行内容"

在某行之后插入：
  old_string: "目标行内容"
  new_string: "目标行内容\n新内容"
```

#### 3. 删除（Delete）

删除指定区域。

```
操作：StrReplace
参数：
  - old_string: 要删除的内容（含上下文以确保唯一）
  - new_string: "" (空字符串) 或仅保留上下文
```

#### 4. 追加（Append）

在文件末尾追加内容。

```
方式一：读取文件最后几行，用 StrReplace 在末尾插入
方式二：读取全文后用 Write 工具写入（仅当追加大量内容时）
```

#### 5. 全局替换（Replace All）

替换文件中所有匹配项。

```
操作：StrReplace
参数：
  - old_string: 要替换的模式
  - new_string: 替换后的内容
  - replace_all: true
```

适用于：术语统一、变量重命名、格式批量修正。

---

## 工作流示例

### 示例 1：创建并迭代编辑

```
用户：新建一个文章草稿
→ [创建] 确认路径，Write 写入初始内容

用户：把第二段改得更详细一些
→ [定位] Read 文件，找到第二段位置
→ [改写] StrReplace 替换第二段

用户：在结尾加一个总结
→ [定位] 读取文件末尾
→ [改写] 在末尾插入总结段落
```

### 示例 2：精确修改

```
用户：把 "旧标题" 改成 "新标题"
→ [定位] Grep 确认 "旧标题" 唯一性
→ [改写] StrReplace(old="旧标题", new="新标题")

用户：删除第 30-35 行
→ [定位] Read offset=29, limit=10 获取上下文
→ [改写] StrReplace 删除目标行，保留上下文衔接
```

---

## 编辑原则

1. **先读后改**：任何编辑前必须先 Read 文件，了解当前内容
2. **精确定位**：使用足够长的 `old_string` 确保唯一匹配
3. **最小改动**：只改必要部分，不重写无关内容
4. **保持格式**：编辑后保持原文的缩进、空行、格式风格
5. **验证结果**：编辑后可选择性地 Read 验证修改是否正确

---

## 错误处理

| 问题 | 处理方式 |
|------|----------|
| `old_string` 不唯一 | 扩展上下文，包含更多行以确保唯一 |
| `old_string` 未找到 | 检查是否有空白字符/换行符差异 |
| 行号超出范围 | 先 Read 确认文件总行数 |
| 编辑后格式错乱 | 检查 `new_string` 的缩进和换行是否正确 |

---

## 参考资源

### examples/editing-workflow.md

完整的编辑工作流示例，包含：
- 创建并迭代编辑文章的全流程
- 按行号精确修改的操作方式
- 搜索定位后修改的步骤
- 删除段落和插入内容的具体方法

**何时查阅**：需要了解具体工具调用方式时，阅读此示例文件。

### references/patterns.md

定位和编辑模式的完整参考，包含：
- 四种定位模式（行号、标题、关键词、上下文）
- 四种编辑模式（替换、插入、删除、重写）
- 边界情况处理（old_string 不唯一、找不到等）
- 常见错误与解决方案

**何时查阅**：遇到复杂编辑场景或错误时，查阅此参考文件。

---

## 与其他 skill 配合

- **doc-writing**：写作时用 file-writer 做精确修订
- **mermaid-diagrams**：生成图后用 file-writer 插入到指定位置
